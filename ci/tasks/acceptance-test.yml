---
platform: linux

image_resource:
  type: docker-image
  source:
    repository: amidos/dcind
inputs:
- name: release
- name: broker-pak
- name: version
params:
  ARM_SUBSCRIPTION_ID: 
  ARM_TENANT_ID:
  ARM_CLIENT_ID:
  ARM_CLIENT_SECRET:
run:
  path: /bin/bash
  args:    
    - -exc
    - |
      source /docker-lib.sh
      start_docker
      DB_USERNAME=broker
      DB_PASSWORD=brokerpass
      DB_NAME=servicebroker

      docker run --rm -p 3306:3306 --name test-mysql -e MYSQL_ROOT_PASSWORD=password -e MYSQL_DATABASE="${DB_NAME}" -e MYSQL_USER="${USERNAME}" -e MYSQL_PASSWORD="${PASSWORD}" -d mysql:5.7
      sleep 10
      chmod +x release/cloud-service-broker.linux
      PORT=8080
      GSB_BROKERPAK_BUILTIN_PATH=broker-pak
      release/cloud-service-broker.linux serve &
      release/cloud-service-broker.linux client run-examples

